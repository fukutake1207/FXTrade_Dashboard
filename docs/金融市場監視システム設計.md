# FX裁量トレード コクピットダッシュボード設計書

**プロジェクト名:** FX Discretionary Trading Cockpit  
**対象通貨ペア:** USDJPY  
**作成日:** 2025年12月28日  
**バージョン:** 1.0

---

## 1. 設計思想と基本方針

### 1.1 役割分担の原則

| コンポーネント | 担当領域 | 情報の性質 |
|-------------|---------|-----------|
| **MT5カスタムインジケーター** | リアルタイム価格分析 | 「今、価格がどう動いているか」 |
| **Webダッシュボード** | コンテキスト・ナラティブ | 「なぜこう動くのか、次に何が起きるか」 |

**Single Source of Truth原則:** 価格データの真実はMT5のみが持ち、同じ計算ロジックを2箇所に持たない。

### 1.2 システム構成概要

```
┌─────────────────────────────────────────────────────────────────┐
│                     ユーザー環境                                  │
│  ┌──────────────┐          ┌──────────────────────────────┐     │
│  │   MT5        │ ←IPC→   │   Webダッシュボード              │     │
│  │ (価格分析)    │          │   (コンテキスト情報)            │     │
│  └──────────────┘          └──────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────┘
                                     ↑
                    ┌────────────────┼────────────────┐
                    ↓                ↓                ↓
            ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
            │ 外部データAPI │ │ ニュースAPI  │ │ Claude API   │
            │ (価格・指数)  │ │              │ │ (ナラティブ)  │
            └──────────────┘ └──────────────┘ └──────────────┘
```

---

## 2. 機能カテゴリ詳細設計

### カテゴリ1: 価格データと統計情報

#### 2.1.1 要件定義

| 項目 | 仕様 |
|-----|-----|
| データ範囲 | 今週（月曜00:00 JST ～ 現在） |
| 過去統計 | 必要 |
| 更新頻度 | 10分毎 |

#### 2.1.2 表示項目

**週間価格サマリー**
```
┌─────────────────────────────────────────────────┐
│ 今週のUSDJPY サマリー                            │
├─────────────────────────────────────────────────┤
│ 週初値:   157.23  │ 現在値:   158.45 (+0.78%)   │
│ 週高値:   159.12  │ 週安値:   156.89           │
│ 週間レンジ: 223pips                             │
│ 平均日レンジ: 89pips (過去4週平均: 76pips)       │
└─────────────────────────────────────────────────┘
```

**過去価格変動統計**
- 過去4週間の同曜日・同時間帯のボラティリティ
- イベント前後の価格変動パターン（経済指標発表時）
- セッション別平均レンジ（東京/ロンドン/NY）

#### 2.1.3 データモデル

```python
@dataclass
class WeeklyPriceData:
    week_start: datetime
    open_price: float
    current_price: float
    high_price: float
    low_price: float
    range_pips: float
    avg_daily_range: float
    
@dataclass
class HistoricalStatistics:
    session: str  # "tokyo" | "london" | "newyork"
    avg_range_4w: float
    avg_volatility_4w: float
    day_of_week_pattern: Dict[str, float]
    event_response_patterns: List[EventPattern]
```

---

### カテゴリ2: 相関資産モニタリング

#### 2.2.1 要件定義

| 項目 | 仕様 |
|-----|-----|
| 対象資産 | ゴールド（XAU/USD）、日経225、S&P500 |
| 相関計算期間 | 過去20営業日（ローリング） |
| 更新頻度 | 10分毎 |

#### 2.2.2 表示レイアウト

```
┌────────────────────────────────────────────────────────────┐
│ 相関資産モニター                              更新: 10:30  │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ゴールド (XAU/USD)     日経225          S&P500           │
│  ────────────────     ────────        ─────────          │
│  $2,634.50 (+0.3%)    38,450 (-0.2%)  5,970 (+0.1%)      │
│                                                            │
│  相関係数 (20日)                                           │
│  ┌─────────────────────────────────────────┐              │
│  │ USDJPY - Gold:    -0.42 (逆相関・中)    │              │
│  │ USDJPY - Nikkei:  +0.68 (順相関・強)    │              │
│  │ USDJPY - S&P500:  +0.31 (順相関・弱)    │              │
│  └─────────────────────────────────────────┘              │
│                                                            │
│  本日の動向                                                │
│  • 日経先物上昇 → 円安圧力継続の可能性                     │
│  • ゴールド横ばい → リスクセンチメント中立                  │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### 2.2.3 相関分析ロジック

```python
class CorrelationAnalyzer:
    def __init__(self, lookback_days: int = 20):
        self.lookback_days = lookback_days
        self.correlation_thresholds = {
            "strong": 0.7,
            "moderate": 0.4,
            "weak": 0.2
        }
    
    def calculate_rolling_correlation(
        self, 
        usdjpy_returns: pd.Series, 
        asset_returns: pd.Series
    ) -> float:
        """ローリング相関係数を計算"""
        return usdjpy_returns.rolling(self.lookback_days).corr(asset_returns).iloc[-1]
    
    def generate_correlation_insight(
        self, 
        correlations: Dict[str, float],
        current_movements: Dict[str, float]
    ) -> str:
        """相関に基づく洞察を生成"""
        insights = []
        for asset, corr in correlations.items():
            move = current_movements.get(asset, 0)
            if abs(corr) > self.correlation_thresholds["moderate"]:
                direction = "円安" if (corr > 0 and move > 0) or (corr < 0 and move < 0) else "円高"
                insights.append(f"{asset}の動きは{direction}圧力を示唆")
        return insights
```

---

### カテゴリ3: 市場セッション情報

#### 2.3.1 要件定義

| 項目 | 仕様 |
|-----|-----|
| 重視セッション | 東京市場 |
| 補助情報 | ニューヨーク市場、ロンドン市場（ナラティブとして） |
| 更新頻度 | 10分毎 |

#### 2.3.2 セッション定義

```python
MARKET_SESSIONS = {
    "tokyo": {
        "name": "東京市場",
        "open_utc": "00:00",
        "close_utc": "06:00",
        "priority": "primary",
        "display_mode": "detailed"
    },
    "london": {
        "name": "ロンドン市場",
        "open_utc": "07:00",
        "close_utc": "16:00",
        "priority": "secondary",
        "display_mode": "narrative"
    },
    "newyork": {
        "name": "ニューヨーク市場",
        "open_utc": "12:00",
        "close_utc": "21:00",
        "priority": "secondary",
        "display_mode": "narrative"
    }
}
```

#### 2.3.3 表示レイアウト

```
┌────────────────────────────────────────────────────────────┐
│ 市場セッション                                             │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ● 東京市場 [アクティブ]  09:00-15:00 JST                  │
│  ─────────────────────────────────────────────────         │
│  現在時刻: 10:30 JST │ 残り時間: 4時間30分                 │
│                                                            │
│  本日の東京セッション統計                                   │
│  ┌───────────────────────────────────────────┐            │
│  │ セッション高値: 158.67                    │            │
│  │ セッション安値: 158.12                    │            │
│  │ 現在レンジ: 55pips (平均: 48pips)         │            │
│  │ ボラティリティ: 平均的                    │            │
│  └───────────────────────────────────────────┘            │
│                                                            │
│  今後のセッション情報                                       │
│  ○ ロンドン市場: 17:00開場 (6時間30分後)                   │
│    └ 前日サマリー: レンジ相場、156.80-158.20で推移         │
│  ○ ニューヨーク市場: 22:00開場 (11時間30分後)              │
│    └ 前日サマリー: 米指標後に上昇、158.45で引け            │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### 2.3.4 セッションタイムラインUI

```
セッション進行状況 (JST基準)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
06:00    09:00    12:00    15:00    18:00    21:00    24:00
  │        │        │        │        │        │        │
  │  休場   │███████ 東京 ███████│        │        │        │
  │        │        │        │        │▓▓▓▓ ロンドン ▓▓▓▓▓│
  │        │        │        │        │        │░░░ NY ░░░│
              ▲現在 (10:30)
```

---

### カテゴリ4: AIナラティブ生成

#### 2.4.1 要件定義

| 項目 | 仕様 |
|-----|-----|
| 更新頻度 | セッション毎（1日3回） |
| ニュースソース | 汎用（特定指定なし） |
| 生成エンジン | Claude API |

#### 2.4.2 ナラティブ生成タイミング

```python
NARRATIVE_SCHEDULE = {
    "tokyo_open": {
        "trigger_time_jst": "09:00",
        "context": "東京セッション開始",
        "focus": ["アジア市場動向", "前日NY終値分析", "本日の経済指標"]
    },
    "london_open": {
        "trigger_time_jst": "17:00",
        "context": "ロンドンセッション開始",
        "focus": ["欧州市場動向", "東京セッション振り返り", "欧州指標"]
    },
    "newyork_open": {
        "trigger_time_jst": "22:00",
        "context": "ニューヨークセッション開始",
        "focus": ["米国市場動向", "日中の動き総括", "米国指標・イベント"]
    }
}
```

#### 2.4.3 ナラティブ表示形式

```
┌────────────────────────────────────────────────────────────┐
│ 🤖 AIマーケットナラティブ                                   │
│    生成時刻: 2025-12-28 09:00 JST (東京セッション開始)      │
├────────────────────────────────────────────────────────────┤
│                                                            │
│ 【マクロ環境】                                              │
│ 米国雇用統計後のドル高基調が継続。FRBの利下げペース鈍化     │
│ 観測からドル需要が根強い。日銀の追加利上げ期待は後退気味。  │
│                                                            │
│ 【本日の注目ポイント】                                      │
│ • 14:00 日銀政策委員会議事要旨（12月会合分）               │
│   → 追加利上げへの言及があれば円高リスク                   │
│ • 本日は米国市場休場（クリスマス振替）                      │
│   → 流動性低下に注意                                       │
│                                                            │
│ 【テクニカル状況サマリー】                                  │
│ 4時間足で上昇トレンド継続中。直近高値159.12がレジスタンス。 │
│ サポートは157.50-157.80ゾーン。                            │
│                                                            │
│ 【リスクシナリオ】                                          │
│ ⚠ 日銀議事要旨でタカ派サプライズ → 157円台前半へ下落      │
│ ⚠ 地政学リスク再燃 → リスクオフで円高                     │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### 2.4.4 Claude API プロンプト設計

```python
NARRATIVE_PROMPT_TEMPLATE = """
あなたはプロのFXアナリストです。以下の情報を統合し、
USDJPY裁量トレーダー向けの簡潔なマーケットナラティブを生成してください。

## 入力情報
- 現在時刻: {current_time}
- セッション: {session_name}
- 価格情報: {price_data}
- 経済指標: {economic_events}
- 最新ニュース: {news_summary}
- 相関資産動向: {correlation_data}

## 出力フォーマット
1. マクロ環境（2-3文）
2. 本日の注目ポイント（箇条書き、最大3項目）
3. テクニカル状況サマリー（1-2文）
4. リスクシナリオ（箇条書き、最大2項目）

簡潔かつ実用的な分析を心がけてください。
"""
```

---

### カテゴリ5: シナリオ分析と重要レベル検出

#### 2.5.1 要件定義

| 項目 | 仕様 |
|-----|-----|
| シナリオ生成 | 自動生成 |
| 重要レベル検出 | 自動検出機能あり |
| 更新頻度 | 10分毎（レベル検出）、セッション毎（シナリオ） |

#### 2.5.2 重要レベル自動検出アルゴリズム

```python
class KeyLevelDetector:
    """重要価格レベルの自動検出"""
    
    def __init__(self):
        self.level_types = [
            "swing_high_low",      # スイングハイ/ロー
            "round_number",        # ラウンドナンバー（.00, .50）
            "pivot_points",        # ピボットポイント
            "volume_profile",      # ボリューム集中帯
            "previous_session"     # 前セッション高安
        ]
    
    def detect_swing_levels(
        self, 
        ohlc_data: pd.DataFrame, 
        lookback: int = 20
    ) -> List[PriceLevel]:
        """スイングハイ/ローを検出"""
        levels = []
        # 直近N本のローソク足でピボット構造を検出
        for i in range(2, len(ohlc_data) - 2):
            # スイングハイ検出
            if (ohlc_data['high'].iloc[i] > ohlc_data['high'].iloc[i-1] and
                ohlc_data['high'].iloc[i] > ohlc_data['high'].iloc[i-2] and
                ohlc_data['high'].iloc[i] > ohlc_data['high'].iloc[i+1] and
                ohlc_data['high'].iloc[i] > ohlc_data['high'].iloc[i+2]):
                levels.append(PriceLevel(
                    price=ohlc_data['high'].iloc[i],
                    level_type="resistance",
                    strength=self._calculate_strength(ohlc_data, i),
                    source="swing_high"
                ))
        return levels
    
    def detect_round_numbers(
        self, 
        current_price: float, 
        range_pips: int = 200
    ) -> List[PriceLevel]:
        """ラウンドナンバーを検出"""
        levels = []
        base = int(current_price)
        for offset in range(-range_pips // 100, range_pips // 100 + 1):
            # .00 レベル
            level_00 = base + offset
            if abs(level_00 - current_price) < range_pips / 100:
                levels.append(PriceLevel(
                    price=float(level_00),
                    level_type="psychological",
                    strength="high",
                    source="round_number_00"
                ))
            # .50 レベル
            level_50 = base + offset + 0.5
            if abs(level_50 - current_price) < range_pips / 100:
                levels.append(PriceLevel(
                    price=level_50,
                    level_type="psychological",
                    strength="medium",
                    source="round_number_50"
                ))
        return levels
```

#### 2.5.3 If-Thenシナリオ自動生成

```
┌────────────────────────────────────────────────────────────┐
│ 📊 シナリオプランナー                  自動生成: 09:00 JST │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  現在価格: 158.45                                          │
│                                                            │
│  【検出された重要レベル】                                   │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│  🔴 159.00 (ラウンドナンバー + 直近高値近辺) - 強い抵抗    │
│  🟡 158.80 (前日高値) - 中程度の抵抗                       │
│  ── 158.45 現在価格 ──────────────────────────────         │
│  🟡 158.00 (ラウンドナンバー) - 中程度のサポート           │
│  🔵 157.50 (スイングロー) - 強いサポート                   │
│                                                            │
│  【自動生成シナリオ】                                       │
│  ┌───────────────────────────────────────────────────┐    │
│  │ シナリオA: 上昇継続                                │    │
│  │ IF 158.80を上抜け (1H終値ベース)                   │    │
│  │ THEN ロング検討                                    │    │
│  │   • エントリー: 158.85-158.90                      │    │
│  │   • ターゲット: 159.00 → 159.50                    │    │
│  │   • ストップ: 158.40                               │    │
│  │   • リスクリワード: 1:2.5                          │    │
│  └───────────────────────────────────────────────────┘    │
│  ┌───────────────────────────────────────────────────┐    │
│  │ シナリオB: レンジ内推移                            │    │
│  │ IF 158.00-158.80のレンジ継続                       │    │
│  │ THEN レンジ下限での押し目買い検討                   │    │
│  │   • エントリー: 158.00-158.10                      │    │
│  │   • ターゲット: 158.60                             │    │
│  │   • ストップ: 157.80                               │    │
│  └───────────────────────────────────────────────────┘    │
│  ┌───────────────────────────────────────────────────┐    │
│  │ シナリオC: 下落転換                                │    │
│  │ IF 158.00を下抜け (日銀議事要旨後など)             │    │
│  │ THEN 様子見 / ショート検討                         │    │
│  │   • 次のサポート: 157.50                           │    │
│  │   • 警戒レベル: 高                                 │    │
│  └───────────────────────────────────────────────────┘    │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### 2.5.4 シナリオ生成ロジック

```python
class ScenarioGenerator:
    """If-Thenシナリオの自動生成"""
    
    def generate_scenarios(
        self,
        current_price: float,
        key_levels: List[PriceLevel],
        market_context: MarketContext
    ) -> List[TradingScenario]:
        scenarios = []
        
        # 上方向シナリオ
        nearest_resistance = self._find_nearest_level(
            key_levels, current_price, direction="above"
        )
        if nearest_resistance:
            scenarios.append(self._create_bullish_scenario(
                current_price, nearest_resistance, key_levels
            ))
        
        # レンジシナリオ
        range_levels = self._detect_range(key_levels, current_price)
        if range_levels:
            scenarios.append(self._create_range_scenario(
                current_price, range_levels
            ))
        
        # 下方向シナリオ
        nearest_support = self._find_nearest_level(
            key_levels, current_price, direction="below"
        )
        if nearest_support:
            scenarios.append(self._create_bearish_scenario(
                current_price, nearest_support, key_levels
            ))
        
        return scenarios
    
    def _calculate_risk_reward(
        self,
        entry: float,
        target: float,
        stop: float
    ) -> float:
        risk = abs(entry - stop)
        reward = abs(target - entry)
        return round(reward / risk, 2) if risk > 0 else 0
```

---

### カテゴリ6: アラートシステム

#### 2.6.1 要件定義

| 項目 | 仕様 |
|-----|-----|
| カスタマイズ | なし（固定条件） |
| アラート条件 | 固定 |

#### 2.6.2 固定アラート条件

```python
FIXED_ALERT_CONDITIONS = {
    "economic_event": {
        "name": "重要経済指標アラート",
        "trigger": "高重要度イベントの30分前",
        "notification": "プッシュ通知 + 画面ハイライト"
    },
    "session_start": {
        "name": "セッション開始アラート",
        "trigger": "各セッション開始5分前",
        "notification": "画面通知"
    },
    "volatility_spike": {
        "name": "ボラティリティ急上昇アラート",
        "trigger": "10分ATRが過去4時間平均の200%超過",
        "notification": "プッシュ通知 + 画面ハイライト"
    },
    "key_level_approach": {
        "name": "重要レベル接近アラート",
        "trigger": "自動検出された重要レベルから10pips以内",
        "notification": "画面通知"
    },
    "correlation_divergence": {
        "name": "相関乖離アラート",
        "trigger": "相関資産との乖離が2σ超過",
        "notification": "画面通知"
    },
    "narrative_update": {
        "name": "ナラティブ更新アラート",
        "trigger": "AIナラティブ生成完了時",
        "notification": "画面通知（バッジ）"
    }
}
```

#### 2.6.3 アラート表示UI

```
┌────────────────────────────────────────────────────────────┐
│ 🔔 アラートセンター                                        │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  アクティブアラート                                         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│  🟡 13:30 重要経済指標まで30分                             │
│       └ 14:00 日銀政策委員会議事要旨                       │
│  🟢 09:00 東京セッション開始済み                           │
│       └ ナラティブ更新完了                                 │
│                                                            │
│  今後の予定アラート                                         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│  ○ 16:55 ロンドンセッション開始5分前                       │
│  ○ 17:00 ナラティブ更新予定                                │
│                                                            │
│  直近のアラート履歴                                         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│  08:55 東京セッション開始5分前                             │
│  08:30 ナラティブ生成開始                                  │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

### カテゴリ7: トレードログとデータ保存

#### 2.7.1 要件定義

| 項目 | 仕様 |
|-----|-----|
| トレードログ | 改善に役立つ範囲で必要 |
| 過去データ保存期間 | 無期限 |

#### 2.7.2 トレードログデータ構造

```python
@dataclass
class TradeLogEntry:
    """トレードログエントリー"""
    # 基本情報
    trade_id: str
    timestamp: datetime
    symbol: str = "USDJPY"
    
    # トレード詳細
    direction: Literal["LONG", "SHORT"]
    entry_price: float
    exit_price: Optional[float]
    position_size: float
    
    # 結果
    profit_loss_pips: Optional[float]
    profit_loss_amount: Optional[float]
    trade_duration_minutes: Optional[int]
    
    # コンテキスト情報（改善分析用）
    entry_context: TradeContext
    exit_context: Optional[TradeContext]
    
    # 自己評価
    pre_trade_confidence: int  # 1-5
    post_trade_evaluation: Optional[str]
    lessons_learned: Optional[str]

@dataclass
class TradeContext:
    """トレード時のコンテキスト情報"""
    session: str
    market_condition: str  # "trending" | "ranging" | "volatile"
    ai_narrative_summary: str
    active_scenarios: List[str]
    key_levels_nearby: List[float]
    correlation_status: Dict[str, float]
    economic_events_upcoming: List[str]
```

#### 2.7.3 改善分析機能

```
┌────────────────────────────────────────────────────────────┐
│ 📈 トレード分析ダッシュボード                               │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  パフォーマンスサマリー                                     │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│  今週: +125pips (5勝2敗)  │  今月: +380pips (18勝9敗)     │
│  勝率: 71.4%              │  平均RR: 1:1.8                │
│                                                            │
│  セッション別パフォーマンス                                 │
│  ┌────────────────────────────────────────────────────┐   │
│  │ 東京:    +180pips (勝率 75%)  ████████████████████ │   │
│  │ ロンドン: +120pips (勝率 65%) ██████████████       │   │
│  │ NY:      +80pips  (勝率 60%) ██████████           │   │
│  └────────────────────────────────────────────────────┘   │
│                                                            │
│  改善ポイント分析                                           │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│  ⚠ 経済指標発表後30分以内のエントリーで損失が多い          │
│    → 発表後のボラティリティ収束を待つことを推奨             │
│  ✓ 東京セッションでの押し目買いが好成績                     │
│    → この戦略を継続推奨                                    │
│                                                            │
│  最近のトレード履歴                                         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│  12/28 10:15 LONG  158.20 → 158.65  +45pips ✓            │
│  12/27 22:30 SHORT 158.80 → 159.10  -30pips ✗            │
│  12/27 14:00 LONG  157.90 → 158.40  +50pips ✓            │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### 2.7.4 データ保存設計

```python
# データベーススキーマ（SQLite/PostgreSQL対応）

class DatabaseSchema:
    """無期限保存対応のデータベース設計"""
    
    TABLES = {
        "trade_logs": """
            CREATE TABLE trade_logs (
                trade_id TEXT PRIMARY KEY,
                timestamp DATETIME NOT NULL,
                symbol TEXT DEFAULT 'USDJPY',
                direction TEXT NOT NULL,
                entry_price REAL NOT NULL,
                exit_price REAL,
                position_size REAL NOT NULL,
                profit_loss_pips REAL,
                profit_loss_amount REAL,
                trade_duration_minutes INTEGER,
                pre_trade_confidence INTEGER,
                post_trade_evaluation TEXT,
                lessons_learned TEXT,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
            )
        """,
        "trade_contexts": """
            CREATE TABLE trade_contexts (
                context_id TEXT PRIMARY KEY,
                trade_id TEXT REFERENCES trade_logs(trade_id),
                context_type TEXT, -- 'entry' or 'exit'
                session TEXT,
                market_condition TEXT,
                ai_narrative_summary TEXT,
                active_scenarios TEXT, -- JSON
                key_levels_nearby TEXT, -- JSON
                correlation_status TEXT, -- JSON
                economic_events_upcoming TEXT -- JSON
            )
        """,
        "historical_narratives": """
            CREATE TABLE historical_narratives (
                narrative_id TEXT PRIMARY KEY,
                generated_at DATETIME NOT NULL,
                session TEXT NOT NULL,
                content TEXT NOT NULL,
                market_data_snapshot TEXT -- JSON
            )
        """,
        "price_statistics": """
            CREATE TABLE price_statistics (
                stat_id TEXT PRIMARY KEY,
                date DATE NOT NULL,
                session TEXT,
                open_price REAL,
                high_price REAL,
                low_price REAL,
                close_price REAL,
                range_pips REAL,
                volatility REAL
            )
        """
    }
    
    # インデックス設計（検索性能最適化）
    INDEXES = [
        "CREATE INDEX idx_trade_logs_timestamp ON trade_logs(timestamp)",
        "CREATE INDEX idx_trade_logs_session ON trade_contexts(session)",
        "CREATE INDEX idx_narratives_date ON historical_narratives(generated_at)",
        "CREATE INDEX idx_price_stats_date ON price_statistics(date)"
    ]
```

---

## 3. 技術アーキテクチャ

### 3.1 システム構成図

```
┌─────────────────────────────────────────────────────────────────────┐
│                         フロントエンド                               │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    React + TypeScript                        │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐   │   │
│  │  │ 価格統計 │ │ 相関資産 │ │セッション │ │ シナリオ     │   │   │
│  │  │ パネル   │ │ パネル   │ │ パネル   │ │ プランナー   │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────────┘   │   │
│  │  ┌──────────────────────┐ ┌─────────────────────────────┐   │   │
│  │  │ AIナラティブパネル   │ │ トレードログ・分析パネル    │   │   │
│  │  └──────────────────────┘ └─────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              ↕ WebSocket / REST API                 │
└─────────────────────────────────────────────────────────────────────┘
                                    ↕
┌─────────────────────────────────────────────────────────────────────┐
│                         バックエンド                                 │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     Python FastAPI                           │   │
│  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────────┐  │   │
│  │  │ データ収集    │ │ 分析エンジン  │ │ ナラティブ生成   │  │   │
│  │  │ サービス      │ │              │ │ サービス         │  │   │
│  │  └───────────────┘ └───────────────┘ └───────────────────┘  │   │
│  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────────┐  │   │
│  │  │ アラート      │ │ シナリオ      │ │ トレードログ     │  │   │
│  │  │ マネージャー  │ │ ジェネレーター│ │ サービス         │  │   │
│  │  └───────────────┘ └───────────────┘ └───────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              ↕                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐      │
│  │ SQLite/      │  │ Redis        │  │ ファイルストレージ   │      │
│  │ PostgreSQL   │  │ (キャッシュ) │  │ (ログ・バックアップ) │      │
│  └──────────────┘  └──────────────┘  └──────────────────────┘      │
└─────────────────────────────────────────────────────────────────────┘
         ↕                    ↕                      ↕
┌──────────────┐     ┌──────────────┐      ┌──────────────┐
│ 外部API       │     │ MT5          │      │ Claude API   │
│ (価格/ニュース)│     │ (IPC経由)    │      │ (ナラティブ)  │
└──────────────┘     └──────────────┘      └──────────────┘
```

### 3.2 技術スタック

| レイヤー | 技術 | 選定理由 |
|---------|-----|---------|
| **フロントエンド** | React 18 + TypeScript | 型安全性、コンポーネント再利用 |
| **状態管理** | Zustand | 軽量、シンプルなAPI |
| **スタイリング** | Tailwind CSS | 高速開発、レスポンシブ対応 |
| **リアルタイム通信** | WebSocket (Socket.io) | 低レイテンシー、双方向通信 |
| **バックエンド** | Python FastAPI | 非同期対応、型ヒント、自動ドキュメント |
| **タスクスケジューラ** | APScheduler | 定期実行（10分毎、セッション毎） |
| **データベース** | SQLite（開発）→ PostgreSQL（本番） | 無期限保存、高性能 |
| **キャッシュ** | Redis | 高速アクセス、セッション管理 |
| **AI** | Claude API (claude-sonnet-4-5) | ナラティブ生成 |
| **MT5連携** | MetaTrader5 Python Package | Pull型データ取得 |

### 3.3 データフロー

```
[10分毎の定期更新]
外部API → データ収集サービス → 分析エンジン → キャッシュ更新 → WebSocket Push → UI更新

[セッション毎の更新]
スケジューラ → ナラティブ生成サービス → Claude API → DB保存 → WebSocket Push → UI更新

[トレードログ記録]
ユーザー入力 → トレードログサービス → コンテキスト取得 → DB保存 → 分析更新 → UI更新
```

---

## 4. 画面レイアウト設計

### 4.1 メインダッシュボード構成

```
┌────────────────────────────────────────────────────────────────────────┐
│ FX Trading Cockpit - USDJPY                              🔔 ⚙️ 👤    │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────┐ │
│  │ 📊 価格統計                  │  │ 🔗 相関資産                      │ │
│  │ ─────────────────────────── │  │ ──────────────────────────────  │ │
│  │ 週初: 157.23  現在: 158.45  │  │ Gold: $2,634 (-0.42)           │ │
│  │ 高値: 159.12  安値: 156.89  │  │ 日経: 38,450 (+0.68)           │ │
│  │ レンジ: 223pips             │  │ S&P:  5,970  (+0.31)           │ │
│  └─────────────────────────────┘  └─────────────────────────────────┘ │
│                                                                        │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────┐ │
│  │ ⏰ セッション                │  │ 🔔 アラート                      │ │
│  │ ─────────────────────────── │  │ ──────────────────────────────  │ │
│  │ ● 東京 [アクティブ]          │  │ 🟡 14:00 日銀議事要旨 (30分前)  │ │
│  │   残り: 4h30m               │  │ 🟢 ナラティブ更新完了           │ │
│  │ ○ ロンドン: 17:00開場       │  │                                 │ │
│  └─────────────────────────────┘  └─────────────────────────────────┘ │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │ 🤖 AIナラティブ                                    更新: 09:00   │ │
│  │ ────────────────────────────────────────────────────────────────  │ │
│  │ 【マクロ環境】米国雇用統計後のドル高基調が継続。FRBの利下げ...   │ │
│  │ 【注目ポイント】• 14:00 日銀議事要旨 • 米国市場休場           │ │
│  │ 【リスク】⚠ タカ派サプライズで157円台へ                        │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │ 📈 シナリオプランナー                                             │ │
│  │ ────────────────────────────────────────────────────────────────  │ │
│  │ 重要レベル: 🔴159.00  🟡158.80  ──158.45──  🟡158.00  🔵157.50  │ │
│  │                                                                    │ │
│  │ [A] 上昇継続  [B] レンジ推移  [C] 下落転換                       │ │
│  │ IF 158.80↑ → LONG (TP:159.00, SL:158.40, RR:1:2.5)              │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │ 📝 トレードログ                                  [+ 新規記録]    │ │
│  │ ────────────────────────────────────────────────────────────────  │ │
│  │ 今週: +125pips (5勝2敗)  │  勝率: 71.4%  │  平均RR: 1:1.8       │ │
│  │ 最新: 12/28 10:15 LONG 158.20→158.65 +45pips ✓                  │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 実装ロードマップ

### Phase 1: 基盤構築（2週間）

| タスク | 詳細 | 優先度 |
|-------|-----|--------|
| プロジェクトセットアップ | React + FastAPI 環境構築 | 🔴 |
| データベース設計 | SQLite スキーマ作成、マイグレーション | 🔴 |
| 基本UIレイアウト | ダッシュボードのグリッド構成 | 🔴 |
| WebSocket基盤 | リアルタイム通信インフラ | 🔴 |

### Phase 2: コア機能実装（3週間）

| タスク | 詳細 | 優先度 |
|-------|-----|--------|
| 価格データ統合 | 外部API連携、統計計算 | 🔴 |
| 相関資産モニター | Gold/日経/S&P データ取得・相関計算 | 🔴 |
| セッション管理 | タイムゾーン処理、セッション状態管理 | 🟡 |
| 重要レベル検出 | スイングハイロー、ラウンドナンバー検出 | 🔴 |

### Phase 3: AI・シナリオ機能（2週間）

| タスク | 詳細 | 優先度 |
|-------|-----|--------|
| Claude API統合 | ナラティブ生成パイプライン | 🔴 |
| シナリオ自動生成 | If-Then ロジック実装 | 🔴 |
| アラートシステム | 固定条件でのアラート実装 | 🟡 |

### Phase 4: ログ・分析機能（2週間）

| タスク | 詳細 | 優先度 |
|-------|-----|--------|
| トレードログUI | 入力フォーム、履歴表示 | 🔴 |
| パフォーマンス分析 | 統計計算、可視化 | 🟡 |
| 改善ポイント抽出 | パターン分析ロジック | 🟡 |

### Phase 5: 統合・最適化（1週間）

| タスク | 詳細 | 優先度 |
|-------|-----|--------|
| 統合テスト | 全機能の結合テスト | 🔴 |
| パフォーマンス最適化 | キャッシュ調整、レンダリング最適化 | 🟡 |
| ドキュメント整備 | ユーザーガイド、API仕様書 | 🟢 |

---

## 6. 付録

### 6.1 外部API候補

| 用途 | サービス | 備考 |
|-----|---------|-----|
| 為替価格 | Alpha Vantage / Twelve Data | 無料枠あり |
| 株価指数 | Yahoo Finance API | 日経・S&P対応 |
| ゴールド価格 | Gold API / Alpha Vantage | XAU/USD |
| 経済指標 | Investing.com (スクレイピング) | カレンダー |
| ニュース | NewsAPI / Finnhub | 汎用ニュース |
| AI | Claude API (Anthropic) | claude-sonnet-4-5 |

### 6.2 MT5連携設計

```python
# Pull型データ取得（推奨方式）
import MetaTrader5 as mt5

class MT5DataFetcher:
    def __init__(self):
        if not mt5.initialize():
            raise RuntimeError("MT5 initialization failed")
    
    def get_current_price(self, symbol: str = "USDJPY") -> dict:
        tick = mt5.symbol_info_tick(symbol)
        return {
            "bid": tick.bid,
            "ask": tick.ask,
            "time": datetime.fromtimestamp(tick.time)
        }
    
    def get_ohlc(
        self, 
        symbol: str, 
        timeframe: int, 
        count: int
    ) -> pd.DataFrame:
        rates = mt5.copy_rates_from_pos(symbol, timeframe, 0, count)
        return pd.DataFrame(rates)
```

### 6.3 設定ファイル例

```yaml
# config.yaml
app:
  name: "FX Trading Cockpit"
  version: "1.0.0"
  symbol: "USDJPY"

update_intervals:
  price_data: 600  # 10分（秒）
  correlation: 600
  key_levels: 600
  narrative: "session"  # セッション毎

sessions:
  primary: "tokyo"
  secondary: ["london", "newyork"]

alerts:
  economic_event_warning: 30  # 分前
  session_start_warning: 5
  volatility_threshold: 2.0  # 倍率

database:
  type: "sqlite"
  path: "./data/cockpit.db"
  retention: "unlimited"

apis:
  claude:
    model: "claude-sonnet-4-5-20250929"
    max_tokens: 1024
  price_data:
    provider: "alpha_vantage"
    api_key: "${ALPHA_VANTAGE_API_KEY}"
```

---

## 7. 変更履歴

| 日付 | バージョン | 変更内容 |
|-----|-----------|---------|
| 2025-12-28 | 1.0 | 初版作成 |

---

*本設計書は、Yasushi様の要件に基づき作成されました。実装フェーズで詳細な調整が必要な場合は、随時更新します。*
