# 修正計画（FXTrade_Dashboard）

## 目的
設計書（`docs/金融市場監視システム設計.md`）と現行実装の不整合を解消し、
API・DB・フロントの契約崩れによる実行時エラーを優先的に解消する。

## 対象範囲
- バックエンド（FastAPI / SQLAlchemy）
- フロントエンド（React / TypeScript）
- 依存関係・設定ファイル

## 方針決定（確定）
- TradeLogは設計書の `TradeLogEntry` に寄せる
- ナラティブ生成は Gemini を正式採用
- USDJPYの価格ソースは MT5 を唯一ソースとする（Single Source of Truth）
- API契約はバックエンドを正としてフロントを合わせる

## 優先度別タスク

### P0（即時修正・実行不能/データ不整合）
1) 相関分析の構文エラー修正  
   - `backend/src/services/correlation_analyzer.py` の不要インデントを除去  
   - 期待効果: インポート時クラッシュの解消

2) トレード統計の集計ロジック修正  
   - `trade_analysis_service.py` で存在しない `pnl` を参照しているため、実モデル（`profit_loss_amount` など）に合わせて計算  
   - 期待効果: `/trades/stats` の500エラー解消

3) Trade API のレスポンスモデル整合  
   - `TradeLogResponse` から未実装項目（`status`, `pnl`）を削除するか、DBにカラム追加するかを決定  
   - 期待効果: `/trades` 取得時のレスポンス検証エラー解消

4) シナリオ生成の価格ソース修正  
   - `market_data_service` が USDJPY を返していないため、MT5経由で取得するか、サービスにUSDJPYを追加  
   - 期待効果: `/scenarios/current` が常に空配列になる問題の解消

5) 価格統計の `stat_id` 生成不備修正  
   - `hasattr` ではなく `stat.stat_id is None` で判定  
   - 期待効果: フォールバック経路でのINSERT失敗回避

6) 依存パッケージ不足の解消  
   - `pytz` を `backend/requirements.txt` に追加  
   - 期待効果: セッションサービスの起動失敗回避

### P1（設計書との整合・ユーザー体験）
7) セッション時間の設計書合わせ  
   - London/NY の開始・終了時刻を設計書に合わせる  
   - 期待効果: UI表示とナラティブ生成の整合性向上

8) フロント/バックの型定義統一  
   - `frontend/src/lib/api.ts` の `TradeLog`・`NarrativeResponse` をバック側の実スキーマに一致させる  
   - 期待効果: UIの表示崩れ・型エラーの解消

9) ナラティブ生成エンジンの統一方針決定  
   - Claude/ Gemini のどちらを正式採用するか決定し、サービス・モデル名・プロンプトを設計書に合わせる  
   - 期待効果: 設計思想との整合、運用ブレの解消

### P2（運用・保守性）
10) 定期更新スケジューラ実装  
   - APScheduler で 10分更新 / セッション毎更新を実装  
   - 期待効果: 設計書の更新頻度を満たす

11) 機密情報管理の見直し  
   - APIキー類は `.env` と `.gitignore` で管理  
   - 期待効果: 機密漏洩リスクの低減

## 実施順序
1. 方針決定の反映（本ドキュメントに記載済み）
2. API契約の整合（バックエンド正 → フロント追従）
3. P0項目の修正

## テスト計画
### バックエンド
- `uvicorn` 起動時に例外が出ないこと
- `/correlations/overview` が正常応答すること
- `/trades/stats` が正常応答すること
- `/scenarios/current` が価格取得できる状態で内容が返ること

### フロントエンド
- 主要パネル（価格/相関/セッション/ナラティブ/シナリオ/トレード）が表示崩れなく描画されること
- TradeLog と Narrative の型エラーが出ないこと

## 完了条件（Definition of Done）
- P0項目が全て解消され、主要APIが500を返さない
- フロントの型定義がバックエンドと一致
- 設計書とのズレ（セッション時間・ナラティブエンジン）が合意済み

## 想定リスク
- MT5が利用できない環境での価格取得失敗（モック/フォールバック要検討）
- AI APIの利用可否（キー未設定時の挙動）
